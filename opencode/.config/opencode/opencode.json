{
  "$schema": "https://opencode.ai/config.json",
  "mcp": {
    "cf-portal": { "enabled": true }
  },
  "permission": {
    "read": "allow",
    "edit": "ask",
    "external_directory": {
      "~/workspace/**": "allow"
    },
    "bash": {
      "*": "ask",
      "git status*": "allow",
      "git log*": "allow",
      "git show*": "allow",
      "git diff*": "allow",
      "git branch*": "allow",
      "git remote -v*": "allow",
      "git rev-parse*": "allow",
      "git describe*": "allow",
      "git ls-files*": "allow",
      "git ls-tree*": "allow",
      "git cat-file*": "allow",
      "git blame*": "allow",
      "git shortlog*": "allow",
      "git reflog*": "allow",
      "git tag -l*": "allow",
      "git stash list*": "allow",
      "git config --get*": "allow",
      "git config --list*": "allow",
      "ls*": "allow",
      "jq*": "allow",
      "yq*": "allow",
      "grep*": "allow"
    }
  },
  "agent": {
    "research": {
      "description": "Researches codebase structure, dependencies, and flow",
      "mode": "subagent",
      "temperature": 0.1,
      "permission": {
        "edit": "deny",
        "bash": "allow",
        "webfetch": "allow"
      },
      "prompt": "You are a codebase research specialist focused on understanding code structure, dependencies, and purpose.\n\nYour primary objectives:\n- Map code flow and execution paths through the codebase\n- Identify dependencies between modules, functions, and components\n- Understand the purpose and responsibility of code sections\n- Locate corresponding tests for production code\n- Analyze git diffs to understand changes and their impact\n- Trace data flow and state management patterns\n\nResearch methodology:\n1. **Initial Discovery**\n   - Use grep/glob to find relevant files by pattern or content\n   - Read key files to understand structure and architecture\n   - Identify entry points and main execution flows\n\n2. **Dependency Analysis**\n   - Map imports/requires to understand module relationships\n   - Identify external dependencies (package.json, requirements.txt, etc.)\n   - Trace function calls and data flow between modules\n\n3. **Code Flow Understanding**\n   - Follow execution paths from entry points\n   - Identify key abstractions and interfaces\n   - Map control flow and business logic\n\n4. **Test Location**\n   - Search for test files following common patterns (*.test.*, *.spec.*, *_test.*, tests/, __tests__/)\n   - Match test files to production code by naming conventions\n   - Identify test frameworks and utilities in use\n\n5. **Git Diff Analysis**\n   - Use git diff/show to understand changes\n   - Identify which files and functions were modified\n   - Assess impact radius of changes\n\nOutput format:\nProvide structured reports with:\n- **Code Purpose**: High-level summary of what the code does\n- **Entry Points**: Where execution begins\n- **Key Dependencies**: Critical imports and external libraries\n- **Code Flow**: Step-by-step execution path\n- **Test Location**: Where tests are located and coverage\n- **Architecture Notes**: Design patterns, abstractions, conventions\n- **File References**: Use `path/to/file.ext:line_number` format"
    },
    "review": {
      "description": "Reviews code for quality, security, and best practices",
      "mode": "subagent",
      "temperature": 0.1,
      "permission": {
        "edit": "deny",
        "webfetch": "allow"
      },
      "prompt": "You are a code reviewer focused on providing constructive feedback.\n\nReview code for:\n- Security vulnerabilities and potential exploits\n- Performance issues and optimization opportunities\n- Code quality and maintainability\n- Best practices for the language/framework\n- Edge cases and potential bugs\n- Error handling and input validation\n- Documentation and code clarity\n- Test coverage gaps\n\nProvide specific, actionable feedback with:\n- File paths and line numbers\n- Clear explanation of the issue\n- Suggested improvements\n- Severity level (critical/high/medium/low)\n\nDo not make direct changes - only analyze and suggest improvements."
    }
  },
  "command": {
    "fix-mr": {
      "description": "{url} address comments left on a GitLab merge request",
      "template": "Fix the comments left in PR review, below are the comments left by reviewers. Don't create a merge request but if you need more information use the `glab` cli. If the current project isn't named !`echo \"$ARGUMENTS\" | sed -n 's/.*cloudflare\\/[^\\/]*\\/\\(.*\\)\\/-\\/merge_requests.*/\\1/p'` please tell me to change directories. Ensure the user has `glab` and `jq` installed and prompt them to install them if not.\n\nMerge request URL:\n$ARGUMENTS\n\nTo find MR branch: `glab mr view -c --repo $(echo \"$ARGUMENTS\" | sed 's|/-/merge_requests/.*||') $(echo \"$ARGUMENTS\" | sed 's|.*/merge_requests/||' | sed 's|[^0-9].*||') --output json | jq -r .source_branch`\nCommand to view comments: `glab mr view -c --repo $(echo \"$ARGUMENTS\" | sed 's|/-/merge_requests/.*||') $(echo \"$ARGUMENTS\" | sed 's|.*/merge_requests/||' | sed 's|[^0-9].*||')`"
    },
    "jira": {
      "description": "{issue | RM | filter | URL} fetch and summarize a JIRA issue, filter, or RM/Epic",
      "template": "Fetch and summarize JIRA issue(s).\n\nInput: $ARGUMENTS\n\nParse the input to identify:\n- Full URL: https://jira.cfdata.org/browse/PROJ-123 or https://jira.cfdata.org/issues/?filter=12345\n- Issue key: PROJ-123, RM-21000, CUSTESC-55467 (format: {PROJECT}-{NUMBER})\n\n**Fetching Data:**\nUse the `cf-portal` MCP server (JIRA tools) to fetch issue data. The MCP server handles authentication automatically.\n\nIMPORTANT: If the input is a filter URL, RM (Release Management), or Epic that contains multiple issues:\n- First fetch the container to get the list of linked issues\n- ASK the user if they want to traverse and summarize all linked issues before proceeding\n- If yes, fetch each linked issue and provide individual summaries\n\nFor each issue, provide a crisp summary that includes:\n\n1. **Overview**: Issue key, summary, status, priority, assignee\n2. **Description**: Key points from the description (2-3 sentences max)\n3. **Activity Analysis**:\n   - Highlight any unresolved blockers or questions in comments\n   - Flag multi-day gaps in responses (e.g., \"No response for 5 days after question on Dec 10\")\n   - Note the last activity date and who responded\n4. **Linked Items**:\n   - GitLab MRs (with status if available)\n   - Related JIRA issues (blockers, dependencies, duplicates)\n   - Parent Epic or RM if applicable\n5. **Red Flags**: Surface anything concerning:\n   - Stale issues (no updates in 7+ days while unresolved)\n   - Unanswered questions\n   - Blocked status without clear blocker\n   - Missing assignee on high priority items\n\nKeep summaries action-oriented. End with suggested next steps if applicable."
    },
    "read-branch-code": {
      "description": "Initialize the context with the code from the current branch",
      "agent": "plan",
      "template": "use a @research subagent to go through the code in the current branch to understand what we are working on"
    },
    "review-branch-code": {
      "description": "Review current code with multiple subagents",
      "agent": "plan",
      "template": "use 3 @review subagent to go through the code in the current branch and the uncommited changes and correlate the results"
    },
    "search": {
      "description": "{query} search the current codebase for specific functionality or behavior",
      "template": "Search the current codebase for specific functionality or behavior related to the provided arguments.\n\n$ARGUMENTS\n\nwhen searching, consider:\n\n1. using tools like rg to search for string literals, function/method names, and classes/structs that match or closely match the search term(s)\n2. constructing a diagram to understand control flow\n3. understanding the dependency tree and whether the search term(s) are used in any dependencies\n4. checking configuration files and scripts\n5. biasing towards code that handles or is related to: user input, input validation, error handling, security/cryptography, I/O boundaries, API calls, and/or big-O complexity.\n\nusage examples:\n\n- /search find cases where JSON parsing errors are not caught\n- /search provide a list of error messages that do not provide actionable information\n- /search find instances where API calls to external services are not retried or rate-limited\n\nthe search should return:\n\n- a list of associated code across the codebase, ranked by relevance (high/med/low)\n- the path to the file \n- code snippets (focused on the users ask + minimal surrounding context)\n\nif you don't find matches, say so."
    },
    "wiki": {
      "description": "{query} search for the given term on the Wiki",
      "subtask": true,
      "template": "Search the Cloudflare Wiki (Atlassian Confluence) for relevant content.\n\nQuery: $ARGUMENTS\n\n**Fetching Data:**\nUse the `cf-portal` MCP server (Wiki tools) to search for content. The MCP server handles authentication automatically.\n\nFrom the results:\n1. List the top 5-10 most relevant pages with their titles and URLs\n2. Briefly summarize what each page appears to cover based on the excerpt\n3. If the user's query seems to match a specific page well, offer to fetch and summarize that page's full content\n\nIf no results are found, suggest alternative search terms."
    }
  }
}
